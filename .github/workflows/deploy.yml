name: CI/CD Pipeline

on:
  push:
    branches: [main, master]

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/triply-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/triply-backend:${{ github.sha }}

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/triply

            # .env.prod 파일이 없으면 에러 (첫 배포 시 수동 생성 필요)
            if [ ! -f .env.prod ]; then
              echo "ERROR: .env.prod 파일이 존재하지 않습니다."
              exit 1
            fi

            # .env.prod에서 IMAGE_TAG 업데이트 (있으면 업데이트, 없으면 추가)
            if grep -q "^IMAGE_TAG=" .env.prod; then
              sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=${{ github.sha }}/" .env.prod
            else
              echo "IMAGE_TAG=${{ github.sha }}" >> .env.prod
            fi

            # docker-compose에서 사용할 환경 변수 내보내기
            export IMAGE_TAG=${{ github.sha }}
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}

            # 1) App 컨테이너가 있으면 먼저 정리
            docker-compose -f docker-compose.prod.yml stop app || true
            docker-compose -f docker-compose.prod.yml rm -f app || true

            # 2) 새 이미지 pull
            docker-compose -f docker-compose.prod.yml pull app

            # 3) 새 컨테이너로 올리기
            docker-compose -f docker-compose.prod.yml up -d app

            # 사용하지 않는 이미지 정리
            docker image prune -f
